const { SlashCommandBuilder, PermissionFlagsBits, EmbedBuilder, AttachmentBuilder } = require("discord.js");
const fs = require("fs");
const path = require("path");

// admin.jsonã¨blacklist.jsonã®ãƒ‘ã‚¹
const adminFilePath = path.join(__dirname, "../json/admin.json");
const blacklistFilePath = path.join(__dirname, "../json/blacklist.json");
const farmPath = path.join(__dirname, "../json/farm.json");
const userDataPath = path.join(__dirname, "../json/userData.json");

module.exports = {
  data: new SlashCommandBuilder()
    .setName("admin")
    .setDescription("ç®¡ç†è€…å°‚ç”¨ã®ã‚³ãƒãƒ³ãƒ‰ã§ã™")
    .addSubcommand((subcommand) =>
      subcommand
        .setName("server")
        .setDescription("ãƒœãƒƒãƒˆãŒå‚åŠ ä¸­ã®ã‚µãƒ¼ãƒãƒ¼ã‚’è¡¨ç¤ºã—ã¾ã™")
    )
    .addSubcommand((subcommand) =>
      subcommand
        .setName("leave")
        .setDescription("æŒ‡å®šã•ã‚ŒãŸã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ãƒœãƒƒãƒˆã‚’é€€å‡ºã•ã›ã¾ã™")
        .addStringOption((option) =>
          option
            .setName("server_id")
            .setDescription("ã‚µãƒ¼ãƒãƒ¼ID")
            .setRequired(true)
        )
    )
    .addSubcommand((subcommand) =>
      subcommand
        .setName("invite")
        .setDescription("æŒ‡å®šã•ã‚ŒãŸã‚µãƒ¼ãƒãƒ¼ã®æ‹›å¾…ãƒªãƒ³ã‚¯ã‚’ç”Ÿæˆã—ã¾ã™")
        .addStringOption((option) =>
          option
            .setName("server_id")
            .setDescription("ã‚µãƒ¼ãƒãƒ¼ID")
            .setRequired(true)
        )
    )
    .addSubcommand((subcommand) =>
      subcommand
        .setName("member")
        .setDescription("ç®¡ç†è€…ã‚’è¿½åŠ ã—ã¾ã™")
        .addUserOption((option) =>
          option
            .setName("user")
            .setDescription("ç®¡ç†è€…ã¨ã—ã¦è¿½åŠ ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼")
            .setRequired(true)
        )
    )
    .addSubcommand((subcommand) =>
      subcommand
        .setName("blacklist")
        .setDescription("ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¾ãŸã¯ã‚µãƒ¼ãƒãƒ¼ã‚’ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆã«ç™»éŒ²ã—ã¾ã™")
        .addStringOption((option) =>
          option
            .setName("type")
            .setDescription("ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆã®ã‚¿ã‚¤ãƒ— (user ã¾ãŸã¯ server)")
            .setRequired(true)
            .addChoices(
              { name: "ãƒ¦ãƒ¼ã‚¶ãƒ¼", value: "user" },
              { name: "ã‚µãƒ¼ãƒãƒ¼", value: "server" }
            )
        )
        .addStringOption((option) =>
          option
            .setName("id")
            .setDescription("ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¾ãŸã¯ã‚µãƒ¼ãƒãƒ¼ID")
            .setRequired(true)
        )
    )
    .addSubcommand((subcommand) =>
      subcommand
        .setName("reload")
        .setDescription("æŒ‡å®šã—ãŸã‚³ãƒãƒ³ãƒ‰ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¾ã™")
        .addStringOption((option) =>
          option
            .setName("command_name")
            .setDescription("ãƒªãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ã®åå‰")
            .setRequired(true)
        )
    )
    .addSubcommand((subcommand) =>
      subcommand
        .setName("db")
        .setDescription("ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æƒ…å ±ã‚’ç¢ºèªã—ã¾ã™")
        .addUserOption((option) =>
          option
            .setName("user")
            .setDescription("ç®¡ç†è€…ã¨ã—ã¦è¿½åŠ ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼")
            .setRequired(true)
        )
    )
    .addSubcommand(subcommand =>
      subcommand
            .setName('code')
            .setDescription('æŒ‡å®šã—ãŸåå‰ã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ã—ã¦é€ä¿¡')
            .addStringOption(option =>
              option.setName('filename')
                .setDescription('å‡ºåŠ›ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã®ãƒ•ã‚¡ã‚¤ãƒ«å')
                .setRequired(true)
         )
    ),

  async execute(interaction) {
    const subcommand = interaction.options.getSubcommand();
    const member = interaction.member;

    try {
      const adminData = JSON.parse(fs.readFileSync(adminFilePath, "utf-8"));

      // å®Ÿè¡Œè€…ãŒç®¡ç†è€…ã‹ã©ã†ã‹ç¢ºèª
      if (!adminData.admins.includes(member.id)) {
        const errorEmbed = new EmbedBuilder()
          .setColor("Red")
          .setTitle("æ¨©é™ã‚¨ãƒ©ãƒ¼")
          .setDescription("ã“ã®ã‚³ãƒãƒ³ãƒ‰ã¯boté–¢ä¿‚è€…ã®ã¿å®Ÿè¡Œã§ãã¾ã™ã€‚(ä¸€èˆ¬ã®æ–¹ã¯ä½¿ç”¨ã§ãã¾ã›ã‚“)");
        return interaction.reply({ embeds: [errorEmbed], ephemeral: true });
      }

      switch (subcommand) {
        case "server":
          // ã‚µãƒ¼ãƒãƒ¼è¡¨ç¤ºå‡¦ç†
          const guilds =
            interaction.client.guilds.cache
              .map((guild) => `**${guild.name}** (ID: ${guild.id})`)
              .join("\n") || "ãƒœãƒƒãƒˆã¯å‚åŠ ã—ã¦ã„ã¾ã›ã‚“ã€‚";
          const serverEmbed = new EmbedBuilder()
            .setColor("Blue")
            .setTitle("å‚åŠ ä¸­ã®ã‚µãƒ¼ãƒãƒ¼ä¸€è¦§")
            .setDescription(guilds);
          await interaction.reply({ embeds: [serverEmbed], ephemeral: true });
          break;

        case "leave":
          // ã‚µãƒ¼ãƒãƒ¼é€€å‡ºå‡¦ç†
          const serverId = interaction.options.getString("server_id");
          const guild = interaction.client.guilds.cache.get(serverId);

          if (!guild) {
            const errorEmbed = new EmbedBuilder()
              .setColor("Red")
              .setTitle("ã‚¨ãƒ©ãƒ¼")
              .setDescription("æŒ‡å®šã•ã‚ŒãŸã‚µãƒ¼ãƒãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
            return interaction.reply({ embeds: [errorEmbed], ephemeral: true });
          }

          await guild.leave();
          const successLeaveEmbed = new EmbedBuilder()
            .setColor("Green")
            .setTitle("ã‚µãƒ¼ãƒãƒ¼é€€å‡ºæˆåŠŸ")
            .setDescription(`${guild.name} ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰é€€å‡ºã—ã¾ã—ãŸã€‚`);
          await interaction.reply({
            embeds: [successLeaveEmbed],
            ephemeral: true,
          });
          break;

        case "invite":
          // æ‹›å¾…ãƒªãƒ³ã‚¯ç”Ÿæˆå‡¦ç†
          const inviteServerId = interaction.options.getString("server_id");
          const inviteGuild =
            interaction.client.guilds.cache.get(inviteServerId);

          if (!inviteGuild) {
            const errorEmbed = new EmbedBuilder()
              .setColor("Red")
              .setTitle("ã‚¨ãƒ©ãƒ¼")
              .setDescription("æŒ‡å®šã•ã‚ŒãŸã‚µãƒ¼ãƒãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
            return interaction.reply({ embeds: [errorEmbed], ephemeral: true });
          }

          const invite = await inviteGuild.invites.create(
            inviteGuild.systemChannel.id,
            {
              unique: true,
              max_uses: 1,
              max_age: 0,
            }
          );

          const inviteEmbed = new EmbedBuilder()
            .setColor("Blue")
            .setTitle("æ‹›å¾…ãƒªãƒ³ã‚¯")
            .setDescription(`æ‹›å¾…ãƒªãƒ³ã‚¯: ${invite.url}`);
          await interaction.reply({ embeds: [inviteEmbed], ephemeral: true });
          break;

        case "member":
          // ç®¡ç†è€…è¿½åŠ å‡¦ç†
          const user = interaction.options.getUser("user");
          const userId = user.id;

          if (!adminData.admins.includes(userId)) {
            adminData.admins.push(userId);
            fs.writeFileSync(adminFilePath, JSON.stringify(adminData, null, 2));

            const successEmbed = new EmbedBuilder()
              .setColor("Green")
              .setTitle("ç®¡ç†è€…è¿½åŠ æˆåŠŸ")
              .setDescription(`${user.tag} ã‚’ç®¡ç†è€…ã¨ã—ã¦è¿½åŠ ã—ã¾ã—ãŸã€‚`);
            await interaction.reply({
              embeds: [successEmbed],
              ephemeral: true,
            });
          } else {
            const alreadyAdminEmbed = new EmbedBuilder()
              .setColor("Red")
              .setTitle("ã‚¨ãƒ©ãƒ¼")
              .setDescription(`${user.tag} ã¯ã™ã§ã«ç®¡ç†è€…ã§ã™ã€‚`);
            await interaction.reply({
              embeds: [alreadyAdminEmbed],
              ephemeral: true,
            });
          }
          break;

        case "blacklist":
          // ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆã«ç™»éŒ²ã™ã‚‹å‡¦ç†
          const type = interaction.options.getString("type"); // user ã¾ãŸã¯ server
          const id = interaction.options.getString("id");

          try {
            // blacklist.jsonã®èª­ã¿è¾¼ã¿
            const blacklistData = JSON.parse(
              fs.readFileSync(blacklistFilePath, "utf-8")
            );

            // ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆã«IDã‚’è¿½åŠ 
            if (type === "user") {
              if (!blacklistData.bannedUsers.includes(id)) {
                blacklistData.bannedUsers.push(id);
              } else {
                const alreadyExistsEmbed = new EmbedBuilder()
                  .setColor("Red")
                  .setTitle("ã‚¨ãƒ©ãƒ¼")
                  .setDescription(
                    `æŒ‡å®šã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ID \`${id}\` ã¯æ—¢ã«ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚`
                  );
                return interaction.reply({
                  embeds: [alreadyExistsEmbed],
                  ephemeral: true,
                });
              }
            } else if (type === "server") {
              if (!blacklistData.bannedServers.includes(id)) {
                blacklistData.bannedServers.push(id);
              } else {
                const alreadyExistsEmbed = new EmbedBuilder()
                  .setColor("Red")
                  .setTitle("ã‚¨ãƒ©ãƒ¼")
                  .setDescription(
                    `æŒ‡å®šã•ã‚ŒãŸã‚µãƒ¼ãƒãƒ¼ID \`${id}\` ã¯æ—¢ã«ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚`
                  );
                return interaction.reply({
                  embeds: [alreadyExistsEmbed],
                  ephemeral: true,
                });
              }
            } else {
              const invalidTypeEmbed = new EmbedBuilder()
                .setColor("Red")
                .setTitle("ã‚¨ãƒ©ãƒ¼")
                .setDescription(
                  "ç„¡åŠ¹ãªã‚¿ã‚¤ãƒ—ãŒæŒ‡å®šã•ã‚Œã¾ã—ãŸã€‚`user` ã¾ãŸã¯ `server` ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"
                );
              return interaction.reply({
                embeds: [invalidTypeEmbed],
                ephemeral: true,
              });
            }

            // å¤‰æ›´ã‚’ä¿å­˜
            fs.writeFileSync(
              blacklistFilePath,
              JSON.stringify(blacklistData, null, 2)
            );

            // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            const successEmbed = new EmbedBuilder()
              .setColor("Green")
              .setTitle("ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆç™»éŒ²æˆåŠŸ")
              .setDescription(
                type === "user"
                  ? `ãƒ¦ãƒ¼ã‚¶ãƒ¼ID \`${id}\` ã‚’ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆã«ç™»éŒ²ã—ã¾ã—ãŸã€‚`
                  : `ã‚µãƒ¼ãƒãƒ¼ID \`${id}\` ã‚’ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆã«ç™»éŒ²ã—ã¾ã—ãŸã€‚`
              );
            await interaction.reply({
              embeds: [successEmbed],
              ephemeral: true,
            });
          } catch (error) {
            console.error(error);

            // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            const errorEmbed = new EmbedBuilder()
              .setColor("Red")
              .setTitle("ã‚¨ãƒ©ãƒ¼")
              .setDescription(
                "ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿ã¾ãŸã¯æ›¸ãè¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚"
              );
            await interaction.reply({ embeds: [errorEmbed], ephemeral: true });
          }
          break;

        case "reload":
          // ã‚³ãƒãƒ³ãƒ‰ã®ãƒªãƒ­ãƒ¼ãƒ‰å‡¦ç†
          const commandName = interaction.options.getString("command_name");
          const commandFilePath = path.join(__dirname, `./${commandName}.js`);

          try {
            delete require.cache[require.resolve(commandFilePath)];
            require(commandFilePath);
            const reloadEmbed = new EmbedBuilder()
              .setColor("Green")
              .setTitle("ã‚³ãƒãƒ³ãƒ‰ãƒªãƒ­ãƒ¼ãƒ‰æˆåŠŸ")
              .setDescription(`${commandName} ã‚³ãƒãƒ³ãƒ‰ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚`);
            await interaction.reply({ embeds: [reloadEmbed], ephemeral: true });
          } catch (error) {
            console.error(error);
            const errorEmbed = new EmbedBuilder()
              .setColor("Red")
              .setTitle("ã‚¨ãƒ©ãƒ¼")
              .setDescription(
                `${commandName} ã‚³ãƒãƒ³ãƒ‰ã®ãƒªãƒ­ãƒ¼ãƒ‰ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚`
              );
            await interaction.reply({ embeds: [errorEmbed], ephemeral: true });
          }
          break;
          
        case "db":
        const targetUser = interaction.options.getUser('user'); // ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—
        if (!targetUser) {
            return interaction.reply({ content: 'âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', ephemeral: true });
        }

        const targetUserId = targetUser.id;
        const userName = targetUser.username; // ãƒ¦ãƒ¼ã‚¶ãƒ¼å

        const userDataPath = './json/userData.json';
        const farmDataPath = './json/farm.json';

        // JSONã‚’èª­ã¿è¾¼ã‚€é–¢æ•°
        function readJSON(filePath) {
            try {
                return JSON.parse(fs.readFileSync(filePath, 'utf8'));
            } catch (err) {
                console.error(`${filePath} ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:`, err);
                return {};
            }
        }

        // ãƒ‡ãƒ¼ã‚¿å–å¾—
        const userData = readJSON(userDataPath);
        const farmData = readJSON(farmDataPath);

        const userStats = userData[targetUserId] || {};
        const farmStats = farmData[targetUserId] || {};

        // ãƒ‡ãƒ¼ã‚¿ãŒã©ã¡ã‚‰ã‚‚ãªã„å ´åˆã®å‡¦ç†
        if (Object.keys(userStats).length === 0 && Object.keys(farmStats).length === 0) {
            return interaction.reply({
                embeds: [
                    new EmbedBuilder()
                        .setColor('Red')
                        .setTitle('âŒ ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“')
                        .setDescription(`æŒ‡å®šã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ <@${targetUserId}> ã®ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚`)
                ],
                ephemeral: true
            });
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿åŸ‹ã‚è¾¼ã¿ä½œæˆ
        const embed = new EmbedBuilder()
            .setColor('Blue')
            .setTitle(`ğŸ“Œ ${userName} ã®ãƒ‡ãƒ¼ã‚¿`)
            .setDescription(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: \`${targetUserId}\``);

        // userData.json ã®æƒ…å ±
        embed.addFields({ name: 'ğŸ“‚ **ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿**', value: ' ' });
        embed.addFields(
            { name: 'ğŸ’° æ‰€æŒé‡‘', value: `${userStats.G ?? '0'} G`, inline: true },
            { name: 'ğŸŒ¾ ç±³ã®ç¨®', value: `${userStats.riceSeeds ?? '0'}`, inline: true },
            { name: 'ğŸ¥• ã«ã‚“ã˜ã‚“ã®ç¨®', value: `${userStats.carrotSeeds ?? '0'}`, inline: true },
            { name: 'ğŸŒ¾ ç±³', value: `${userStats.rice ?? '0'}`, inline: true },
            { name: 'ğŸ¥• ã«ã‚“ã˜ã‚“', value: `${userStats.carrot ?? '0'}`, inline: true }
        );

        // farm.json ã®æƒ…å ±
        embed.addFields({ name: 'ğŸ“‚ **è¾²å ´ãƒ‡ãƒ¼ã‚¿**', value: ' ' });
        embed.addFields(
            { name: 'ğŸ¡ è¾²å ´ãƒ¬ãƒ™ãƒ«', value: `${farmStats.farmLevel ?? '1'}`, inline: true },
            { name: 'ğŸŒ± æ¤ãˆãŸç¨®', value: `${farmStats.plantedSeeds ?? '0'}`, inline: true },
            { name: 'ğŸ•’ åç©«äºˆå®š', value: farmStats.nextHarvestTime ? `<t:${Math.floor(farmStats.nextHarvestTime / 1000)}:R>` : 'æœªå®š', inline: true },
            { name: 'ğŸŒ¾ è‚²ã¦ã¦ã„ã‚‹ä½œç‰©', value: farmStats.plantedKind ?? 'ãªã—', inline: true }
        );

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
        await interaction.reply({ embeds: [embed], ephemeral: true });
          break;
          case "code":
    try {
        const filename = interaction.options.getString('filename');

        // ãƒ•ã‚¡ã‚¤ãƒ«ã®æ‹¡å¼µå­ãƒã‚§ãƒƒã‚¯ï¼ˆçœç•¥å¯èƒ½ï¼‰
        if (!filename.endsWith('.js')) {
            return interaction.reply({ content: '`.js` ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿æŒ‡å®šã§ãã¾ã™ã€‚', ephemeral: true });
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã®æ±ºå®š
        const filePath = path.join(__dirname, filename);

        // ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        if (!fs.existsSync(filePath)) {
            return interaction.reply({ content: `ãƒ•ã‚¡ã‚¤ãƒ« \`${filename}\` ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚`, ephemeral: true });
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ·»ä»˜ã—ã¦è¿”ä¿¡
        const file = new AttachmentBuilder(filePath);
        await interaction.reply({ content: `ãƒ•ã‚¡ã‚¤ãƒ« \`${filename}\` ã‚’é€ä¿¡ã—ã¾ã™ã€‚`, files: [file] });

    } catch (error) {
        console.error("ãƒ•ã‚¡ã‚¤ãƒ«é€ä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ:", error);
        interaction.reply({ content: 'ãƒ•ã‚¡ã‚¤ãƒ«ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', ephemeral: true });
    }
    break;
        default:
          break;
      }
    } catch (error) {
      console.error(error);
      const errorEmbed = new EmbedBuilder()
        .setColor("Red")
        .setTitle("ã‚¨ãƒ©ãƒ¼")
        .setDescription("äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
      await interaction.reply({ embeds: [errorEmbed], ephemeral: true });
    }
  },
};
